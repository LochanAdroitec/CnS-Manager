<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Viewer - Fixed</title>

    <!-- CSRF Tokens -->
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

    <!-- Thymeleaf Inline JavaScript -->
    <script th:if="${documentId}" th:inline="javascript">
        window.documentId = /*[[${documentId}]]*/ null;
        window.userRole = /*[[${userRole}]]*/ 'Viewer';
        window.documentInfo = {
            title: /*[[${document != null ? document.title : 'Document'}]]*/ 'Document',
            productCode: /*[[${document != null ? document.productCode : 'N/A'}]]*/ 'N/A',
            edition: /*[[${document != null ? document.edition : 'N/A'}]]*/ 'N/A',
            publishDate: /*[[${document != null ? document.publishDate : 'N/A'}]]*/ 'N/A',
            totalPages: /*[[${document != null ? document.noOfPages : 0}]]*/ 0,
            notes: /*[[${document != null ? document.notes : 'No notes available'}]]*/ 'No notes available',
            tagNames: /*[[${document != null ? document.tagNames : ''}]]*/ 'N/A',
            classificationNames: /*[[${document != null ? document.classificationNames : ''}]]*/ '',
            groupNames: /*[[${document != null ? document.groupNames : ''}]]*/ ''
        };
    </script>

    <link rel="stylesheet" href="/bootstrap-icons/bootstrap-icons.css">
    <script src="/pdfjs/pdf.min.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #525659;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s ease;
        }

        /* ==================== NAVIGATION BAR - FIXED HEIGHT ==================== */
        .unified-nav {
            height: 56px;
            min-height: 56px;
            max-height: 56px;
            background: #323639;
            border-bottom: 1px solid #1e1e1e;
            display: flex;
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
            position: relative;
            z-index: 1000;
            gap: 20px;
            flex-shrink: 0;
            transition: background-color 0.3s ease;
        }

        .nav-left { display: flex; align-items: center; gap: 16px; flex-shrink: 0; }
        .nav-center { display: flex; align-items: center; gap: 20px; flex: 1; justify-content: center; max-width: 800px; }
        .nav-right { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }

        .document-header { display: flex; flex-direction: column; min-width: 0; }
        .document-title {
            font-size: 14px;
            font-weight: 600;
            color: #f1f3f4;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 300px;
        }
        .document-meta { font-size: 12px; color: #9aa0a6; margin-top: 2px; }

        .nav-icon-btn {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 6px;
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            color: #9aa0a6;
            font-size: 16px;
        }
        .nav-icon-btn:hover { background: #4e5256; color: #e8eaed; }
        .nav-icon-btn.active { color: #4285f4; }

        /* ==================== ZOOM CONTROLS ==================== */
        .zoom-group { display: flex; align-items: center; gap: 8px; position: relative; }
        .zoom-btn {
            width: 32px;
            height: 32px;
            border: 1px solid #5f6368;
            border-radius: 6px;
            background: #3c4043;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 14px;
            color: #e8eaed;
        }
        .zoom-btn:hover { background: #4e5256; }
        .zoom-btn:disabled { opacity: 0.4; cursor: not-allowed; }

        .zoom-value-container { position: relative; }
        #zoomValue {
            min-width: 60px;
            text-align: center;
            font-size: 13px;
            color: #e8eaed;
            font-weight: 500;
            cursor: pointer;
            padding: 6px 8px;
            border-radius: 4px;
            transition: background 0.2s;
            user-select: none;
        }
        #zoomValue:hover { background: #4e5256; }

        .zoom-dropdown {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-top: 8px;
            background: #3c4043;
            border: 1px solid #5f6368;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            min-width: 120px;
            z-index: 2000;
            display: none;
            overflow: hidden;
        }
        .zoom-dropdown.show { display: block; }

        .zoom-option {
            padding: 10px 16px;
            font-size: 13px;
            color: #e8eaed;
            cursor: pointer;
            transition: background 0.2s;
            text-align: center;
        }
        .zoom-option:hover { background: #4e5256; }
        .zoom-option.active { background: #4285f4; color: white; font-weight: 600; }

        /* ==================== PAGE JUMP ==================== */
        .page-jump-group {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 10px;
            border: 1px solid #5f6368;
            border-radius: 6px;
            background: #3c4043;
        }
        .page-jump-label { font-size: 13px; color: #9aa0a6; white-space: nowrap; }
        .page-jump-input {
            width: 50px;
            padding: 3px 6px;
            border: 1px solid #5f6368;
            border-radius: 4px;
            font-size: 13px;
            text-align: center;
            outline: none;
            background: #292a2d;
            color: #e8eaed;
        }
        .page-jump-input:focus { border-color: #4285f4; }
        .page-jump-total { font-size: 13px; color: #e8eaed; font-weight: 500; }

        /* ==================== MAIN CONTAINER - PERFECTLY ALIGNED ==================== */
        .main-container {
            display: flex;
            flex: 1;
            height: calc(100vh - 56px);
            min-height: 0;
            overflow: hidden;
            position: relative;
        }

        /* ==================== THUMBNAIL SIDEBAR - FIXED WIDTH ==================== */
        .thumbnail-sidebar {
            width: 200px;
            min-width: 200px;
            max-width: 200px;
            background: #2d3748;
            border-right: 1px solid #1e1e1e;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 10px;
            transition: width 0.3s ease, min-width 0.3s ease, max-width 0.3s ease;
            flex-shrink: 0;
        }
        .thumbnail-sidebar.closed {
            width: 0;
            min-width: 0;
            max-width: 0;
            padding: 0;
            border: none;
            overflow: hidden;
        }

        .thumbnails-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
            padding-bottom: 20px;
        }

        .thumbnail-item {
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            padding: 5px;
            border-radius: 4px;
            width: 100%;
        }
        .thumbnail-item:hover { background: #4a5568; }
        .thumbnail-item.active {
            background: #4285f4;
            box-shadow: 0 0 0 2px #4285f4;
        }

        .thumbnail-canvas {
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            max-width: 150px;
            display: block;
            margin: 0 auto;
            border: 2px solid transparent;
        }

        .thumbnail-item.active .thumbnail-canvas {
            border-color: #4285f4;
        }

        .thumbnail-page-num {
            color: #a0aec0;
            font-size: 12px;
            margin-top: 5px;
            font-weight: 500;
        }
        .thumbnail-item.active .thumbnail-page-num {
            color: white;
            font-weight: 600;
        }

        /* ==================== PDF VIEWER - CHROME ACCURATE ==================== */
        .pdf-viewer-area {
            flex: 1;
            background: #525659;
            display: flex;
            overflow: auto;
            position: relative;
            scroll-behavior: auto !important;
            min-width: 0;
            transition: background-color 0.3s ease;
        }

        .pdf-pages-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0px;
            padding: 20px 0;
            margin: 0 auto;
            min-height: 100%;
        }

        .pdf-canvas-wrapper {
            background: white;
            box-shadow: 0 0 0 1px rgba(0,0,0,0.1), 0 2px 4px rgba(0,0,0,0.2);
            display: inline-block;
            position: relative;
            margin: 0;
            margin-bottom: 10px;
            flex-shrink: 0;
        }

        .pdf-canvas-wrapper:last-child {
            margin-bottom: 0;
        }

        .pdf-canvas-wrapper canvas {
            display: block;
            width: 100%;
            height: auto;
        }

        .pdf-canvas-wrapper.loading {
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
        }

        .pdf-canvas-wrapper.loading::before {
            content: '';
            width: 30px;
            height: 30px;
            border: 3px solid #e2e8f0;
            border-top-color: #4285f4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .page-number-label {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            color: #fff;
            background: rgba(0,0,0,0.7);
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 500;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 10;
        }

        .pdf-canvas-wrapper:hover .page-number-label {
            opacity: 1;
        }

        /* ==================== DOCUMENT INFO SIDEBAR - FIXED WIDTH ==================== */
        .sidebar {
            width: 320px;
            min-width: 320px;
            max-width: 320px;
            background: #3c4043;
            border-left: 1px solid #1e1e1e;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            padding: 24px;
            transition: width 0.3s ease, min-width 0.3s ease, max-width 0.3s ease, background-color 0.3s ease;
            flex-shrink: 0;
        }
        .sidebar.closed {
            width: 0;
            min-width: 0;
            max-width: 0;
            padding: 0;
            border: none;
            overflow: hidden;
        }

        .sidebar-title { font-size: 18px; font-weight: 600; color: #e8eaed; margin-bottom: 20px; }

        .info-item { margin-bottom: 20px; }
        .info-label {
            font-size: 12px;
            color: #9aa0a6;
            margin-bottom: 6px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .info-value { font-size: 14px; color: #e8eaed; font-weight: 500; }
        .info-tags { display: flex; flex-wrap: wrap; gap: 6px; }
        .tag-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            background: #5f6368;
            color: #e8eaed;
        }
        .classification-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            background: #1a73e8;
            color: white;
        }
        .group-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            background: #188038;
            color: white;
        }
        .info-notes { font-size: 13px; color: #9aa0a6; line-height: 1.6; }

        /* ==================== EMPTY STATE TEXT STYLING ==================== */
        .empty-state-text {
            font-size: 13px;
            color: #6b7280;
            font-style: italic;
        }

        body.light-mode .empty-state-text {
            color: #9ca3af;
        }

        /* ==================== LIGHT MODE ==================== */
        body.light-mode {
            background: #f5f7fa;
        }

        body.light-mode .unified-nav {
            background: white;
            border-bottom-color: #e2e8f0;
        }

        body.light-mode .document-title {
            color: #1a202c;
        }

        body.light-mode .document-meta {
            color: #718096;
        }

        body.light-mode .nav-icon-btn {
            color: #4a5568;
        }

        body.light-mode .nav-icon-btn:hover {
            background: #f7fafc;
            color: #2d3748;
        }

        body.light-mode .zoom-btn {
            background: white;
            border-color: #e2e8f0;
            color: #2d3748;
        }

        body.light-mode .zoom-btn:hover {
            background: #f7fafc;
        }

        body.light-mode #zoomValue {
            color: #2d3748;
        }

        body.light-mode #zoomValue:hover {
            background: #f7fafc;
        }

        body.light-mode .zoom-dropdown {
            background: white;
            border-color: #e2e8f0;
        }

        body.light-mode .zoom-option {
            color: #2d3748;
        }

        body.light-mode .zoom-option:hover {
            background: #f7fafc;
        }

        body.light-mode .page-jump-group {
            background: #f8f9fa;
            border-color: #e2e8f0;
        }

        body.light-mode .page-jump-label {
            color: #718096;
        }

        body.light-mode .page-jump-input {
            background: white;
            border-color: #e2e8f0;
            color: #2d3748;
        }

        body.light-mode .page-jump-total {
            color: #2d3748;
        }

        body.light-mode .pdf-viewer-area {
            background: #e5e7eb;
        }

        body.light-mode .sidebar {
            background: white;
            border-left-color: #e2e8f0;
        }

        body.light-mode .sidebar-title {
            color: #1a202c;
        }

        body.light-mode .info-label {
            color: #718096;
        }

        body.light-mode .info-value {
            color: #2d3748;
        }

        body.light-mode .tag-badge {
            background: #e2e8f0;
            color: #2d3748;
        }

        body.light-mode .classification-badge {
            background: #dbeafe;
            color: #1e40af;
        }

        body.light-mode .group-badge {
            background: #d1fae5;
            color: #065f46;
        }

        body.light-mode .info-notes {
            color: #718096;
        }

        /* ==================== TOGGLE BUTTONS ==================== */
        .toggle-sidebar-btn {
            position: fixed;
            top: 70px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #3c4043;
            color: #e8eaed;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
            transition: all 0.3s ease;
            z-index: 1001;
        }
        .toggle-sidebar-btn:hover { background: #5f6368; transform: scale(1.1); }

        body.light-mode .toggle-sidebar-btn {
            background: white;
            color: #2d3748;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        body.light-mode .toggle-sidebar-btn:hover {
            background: #f7fafc;
        }

        /* ==================== ZOOM INDICATOR ==================== */
        .zoom-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 20px 35px;
            border-radius: 12px;
            font-size: 32px;
            font-weight: 600;
            z-index: 9998;
            display: none;
            pointer-events: none;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
        }
        .zoom-indicator.show {
            display: block;
            animation: zoomPulse 0.5s ease;
        }

        @keyframes zoomPulse {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
            100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

        /* ==================== MODALS ==================== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }
        .modal.active { display: flex; }

        .modal-content {
            background: #3c4043;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        body.light-mode .modal-content {
            background: white;
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #5f6368;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        body.light-mode .modal-header {
            border-bottom-color: #e2e8f0;
        }

        .modal-header h2 { font-size: 18px; font-weight: 600; color: #e8eaed; }

        body.light-mode .modal-header h2 {
            color: #1a202c;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 20px;
            color: #9aa0a6;
        }
        .modal-close:hover { color: #e8eaed; }

        body.light-mode .modal-close {
            color: #718096;
        }

        body.light-mode .modal-close:hover {
            color: #2d3748;
        }

        .modal-body { padding: 24px; }
        .modal-body-center { text-align: center; }

        .modal-icon {
            width: 80px;
            height: 80px;
            background: #4285f4;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
        }
        .modal-icon i { font-size: 36px; color: white; }
        .modal-icon.danger { background: #f56565; }

        .modal-title-large { font-size: 20px; font-weight: 600; color: #e8eaed; margin-bottom: 8px; }

        body.light-mode .modal-title-large {
            color: #1a202c;
        }

        .modal-text { font-size: 14px; color: #9aa0a6; line-height: 1.6; }

        body.light-mode .modal-text {
            color: #718096;
        }

        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 14px; font-weight: 500; color: #e8eaed; margin-bottom: 8px; }

        body.light-mode .form-label {
            color: #2d3748;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #5f6368;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
            background: #292a2d;
            color: #e8eaed;
        }
        .form-input:focus { border-color: #4285f4; }

        body.light-mode .form-input {
            background: white;
            border-color: #e2e8f0;
            color: #2d3748;
        }

        .modal-footer {
            padding: 20px 24px;
            border-top: 1px solid #5f6368;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        body.light-mode .modal-footer {
            border-top-color: #e2e8f0;
        }

        .btn-cancel, .btn-primary, .btn-danger {
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }
        .btn-cancel { background: #5f6368; color: #e8eaed; }
        .btn-cancel:hover { background: #80868b; }
        .btn-primary { background: #4285f4; color: white; }
        .btn-primary:hover { background: #3367d6; }
        .btn-danger { background: #f56565; color: white; }
        .btn-danger:hover { background: #e53e3e; }

        body.light-mode .btn-cancel {
            background: #e2e8f0;
            color: #2d3748;
        }

        body.light-mode .btn-cancel:hover {
            background: #cbd5e0;
        }

        /* ==================== NOTIFICATIONS ==================== */
        .notification {
            position: fixed;
            top: 70px;
            right: 20px;
            background: #3c4043;
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 10001;
            animation: slideIn 0.3s ease;
            color: #e8eaed;
        }
        .notification.show { display: flex; }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification.success { border-left: 4px solid #48bb78; }
        .notification.error { border-left: 4px solid #f56565; }
        .notification.warning { border-left: 4px solid #ed8936; }

        body.light-mode .notification {
            background: white;
            color: #2d3748;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .notification-close {
            background: none;
            border: none;
            cursor: pointer;
            color: #9aa0a6;
            padding: 4px;
        }

        body.light-mode .notification-close {
            color: #718096;
        }

        /* ==================== LOADING SPINNER ==================== */
        .loading-spinner {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 16px;
        }
        .loading-spinner.active { display: flex; }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #5f6368;
            border-top-color: #4285f4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-spinner span {
            color: #e8eaed;
        }

        /* ==================== PRESENT MODE ==================== */
        .present-mode {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            z-index: 10000 !important;
            background: #000 !important;
            padding: 20px !important;
        }

        .present-mode .pdf-pages-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100%;
        }

        .present-mode-controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            padding: 10px 20px;
            border-radius: 8px;
            display: none;
            align-items: center;
            gap: 15px;
            z-index: 10001;
        }
        .present-mode-controls.show { display: flex; }

        .present-mode-controls button {
            background: transparent;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
            transition: background 0.2s;
        }
        .present-mode-controls button:hover { background: rgba(255,255,255,0.2); }
        .present-mode-controls .page-info { color: white; font-size: 14px; }
    </style>
</head>
<body>

<!-- ==================== NAVIGATION BAR ==================== -->
<div class="unified-nav">
    <div class="nav-left">
        <button class="nav-icon-btn" onclick="toggleThumbnailSidebar()" title="Toggle Thumbnails">
            <i class="bi bi-grid-3x3-gap"></i>
        </button>
        <div class="document-header">
            <div class="document-title" id="topDocTitle">Loading...</div>
            <div class="document-meta" id="topDocMeta">Loading...</div>
        </div>
    </div>

    <div class="nav-center">
        <div class="zoom-group">
            <button class="zoom-btn" onclick="zoomOut()" title="Zoom Out">
                <i class="bi bi-dash"></i>
            </button>
            <div class="zoom-value-container">
                <span id="zoomValue" onclick="toggleZoomDropdown()">100%</span>
                <div class="zoom-dropdown" id="zoomDropdown">
                    <div class="zoom-option" onclick="setZoom(0.5)">50%</div>
                    <div class="zoom-option" onclick="setZoom(0.75)">75%</div>
                    <div class="zoom-option active" onclick="setZoom(1.0)">100%</div>
                    <div class="zoom-option" onclick="setZoom(1.25)">125%</div>
                    <div class="zoom-option" onclick="setZoom(1.5)">150%</div>
                    <div class="zoom-option" onclick="setZoom(1.75)">175%</div>
                    <div class="zoom-option" onclick="setZoom(2.0)">200%</div>
                    <div class="zoom-option" onclick="setZoom(2.5)">250%</div>
                    <div class="zoom-option" onclick="setZoom(3.0)">300%</div>
                </div>
            </div>
            <button class="zoom-btn" onclick="zoomIn()" title="Zoom In">
                <i class="bi bi-plus"></i>
            </button>
        </div>

        <div class="page-jump-group">
            <input type="number" class="page-jump-input" id="pageJumpInput" min="1"
                   placeholder="1" onkeypress="if(event.key==='Enter') jumpToPageInstant()"/>
            <span class="page-jump-label">/</span>
            <span class="page-jump-total" id="totalPagesDisplay">--</span>
        </div>
    </div>

    <div class="nav-right">
        <button class="nav-icon-btn" id="downloadIconBtn" onclick="showDownloadModal()"
                th:if="${userRole != 'Viewer'}" style="display: none;" title="Download">
            <i class="bi bi-download"></i>
        </button>
        <button class="nav-icon-btn" id="bookmarkIconBtn" onclick="handleBookmarkClick()" title="Bookmark">
            <i class="bi bi-bookmark" id="bookmarkIcon"></i>
        </button>
        <button class="nav-icon-btn" onclick="enterPresentMode()" title="Present Mode">
            <i class="bi bi-display"></i>
        </button>
        <button class="nav-icon-btn" id="themeToggleBtn" onclick="toggleTheme()" title="Toggle Dark/Light Mode">
            <i class="bi bi-moon-fill"></i>
        </button>
    </div>
</div>

<!-- ==================== MAIN CONTAINER ==================== -->
<div class="main-container">
    <div class="thumbnail-sidebar" id="thumbnailSidebar">
        <div class="thumbnails-container" id="thumbnailsContainer"></div>
    </div>

    <div class="pdf-viewer-area" id="pdfViewerArea">
        <div class="pdf-pages-container" id="pdfPagesContainer"></div>
    </div>

    <div class="sidebar" id="sidebar">
        <h2 class="sidebar-title">Document Info</h2>

        <div class="info-item">
            <div class="info-label">Title</div>
            <div class="info-value" id="sidebarTitle">Loading...</div>
        </div>

        <div class="info-item">
            <div class="info-label">Product Code</div>
            <div class="info-value" id="sidebarProductCode">Loading...</div>
        </div>

        <div class="info-item">
            <div class="info-label">Edition</div>
            <div class="info-value" id="sidebarEdition">Loading...</div>
        </div>

        <div class="info-item">
            <div class="info-label">Publication Date</div>
            <div class="info-value format-date" id="sidebarPublishDate">Loading...</div>
        </div>

        <div class="info-item">
            <div class="info-label">Tags</div>
            <div class="info-tags" id="sidebarTags">
                <span class="empty-state-text">No tags</span>
            </div>
        </div>

        <div class="info-item">
            <div class="info-label">Classifications</div>
            <div class="info-tags" id="sidebarClassifications">
                <span class="empty-state-text">No classifications</span>
            </div>
        </div>

        <div class="info-item">
            <div class="info-label">Groups</div>
            <div class="info-tags" id="sidebarGroups">
                <span class="empty-state-text">No groups assigned</span>
            </div>
        </div>

        <div class="info-item">
            <div class="info-label">Notes</div>
            <div class="info-notes" id="sidebarNotes">
                <span class="empty-state-text">No notes available</span>
            </div>
        </div>
    </div>
</div>

<button class="toggle-sidebar-btn" id="toggleSidebarBtn" onclick="toggleSidebar()" title="Toggle Document Info">
    <i class="bi bi-arrow-bar-right"></i>
</button>

<div class="loading-spinner" id="loadingSpinner">
    <div class="spinner"></div>
    <span>Loading document...</span>
</div>

<div class="zoom-indicator" id="zoomIndicator">100%</div>

<!-- MODALS -->
<div class="modal" id="bookmarkModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Bookmark Document</h2>
            <button class="modal-close" onclick="closeBookmarkModal()">×</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Bookmark Name</label>
                <input type="text" class="form-input" id="bookmarkName" placeholder="Enter a name for this bookmark"/>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-cancel" onclick="closeBookmarkModal()">Cancel</button>
            <button class="btn-primary" onclick="saveBookmark()">Save Bookmark</button>
        </div>
    </div>
</div>

<div class="modal" id="removeBookmarkModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Remove Bookmark</h2>
            <button class="modal-close" onclick="closeRemoveBookmarkModal()">×</button>
        </div>
        <div class="modal-body modal-body-center">
            <div class="modal-icon danger">
                <i class="bi bi-exclamation-triangle-fill"></i>
            </div>
            <h3 class="modal-title-large">Remove This Bookmark?</h3>
            <p class="modal-text">Are you sure you want to remove this bookmark? This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
            <button class="btn-cancel" onclick="closeRemoveBookmarkModal()">Cancel</button>
            <button class="btn-danger" onclick="confirmRemoveBookmark()">Yes, Remove Bookmark</button>
        </div>
    </div>
</div>

<div class="modal" id="downloadModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Download PDF</h2>
            <button class="modal-close" onclick="closeDownloadModal()">×</button>
        </div>
        <div class="modal-body modal-body-center">
            <div class="modal-icon">
                <i class="bi bi-shield-fill-check"></i>
            </div>
            <h3 class="modal-title-large">Watermarked Download</h3>
            <p class="modal-text">This PDF will be downloaded with watermarks for security purposes.</p>
        </div>
        <div class="modal-footer">
            <button class="btn-cancel" onclick="closeDownloadModal()">Cancel</button>
            <button class="btn-primary" onclick="confirmDownload()">Download with Watermark</button>
        </div>
    </div>
</div>

<div class="notification" id="notification">
    <i class="bi bi-check-circle-fill"></i>
    <span id="notificationText"></span>
    <button class="notification-close" onclick="closeNotification()">
        <i class="bi bi-x"></i>
    </button>
</div>

<div class="present-mode-controls" id="presentModeControls">
    <button onclick="presentPrevPage()" title="Previous Page">
        <i class="bi bi-chevron-left"></i>
    </button>
    <span class="page-info" id="presentPageInfo">1 / 1</span>
    <button onclick="presentNextPage()" title="Next Page">
        <i class="bi bi-chevron-right"></i>
    </button>
    <button onclick="exitPresentMode()" title="Exit Present Mode">
        <i class="bi bi-x-lg"></i>
    </button>
</div>

<script th:inline="javascript">
    window.username = [[${username}]];
</script>

<script>
    // ==================== GLOBAL STATE ====================
    let isCurrentlyBookmarked = false;
    let isDarkMode = true;
    let isPresentMode = false;
    let zoomTimeout = null;
    let pendingZoom = null;
    let isZooming = false;
    let presentCurrentPage = 1;

    const API_BASE_URL = '/documents';
    let pdfDoc = null;
    let scale = 1.0;
    let documentId = window.documentId;
    let renderedPages = new Map();
    let currentVisiblePage = 1;
    let pageRegistry = new Map();
    let pageHeights = new Map();
    let zoomIndicatorTimeout = null;
    let isInitialLoad = true;

    pdfjsLib.GlobalWorkerOptions.workerSrc = '/pdfjs/pdf.worker.min.js';

    // ==================== INITIALIZATION ====================
    document.addEventListener('DOMContentLoaded', function() {
        loadThemePreference();

        if (window.documentInfo) {
            updateDocumentInfo(window.documentInfo);
        }

        formatAllDates();

        const downloadBtn = document.getElementById('downloadIconBtn');
        if (downloadBtn && window.userRole !== 'Viewer') {
            downloadBtn.style.display = 'flex';
        }

        if (documentId) {
            loadDocument(documentId);
            checkIfBookmarked();
        } else {
            showError('No document ID provided');
        }

        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('zoomDropdown');
            const zoomValue = document.getElementById('zoomValue');
            if (!dropdown.contains(e.target) && e.target !== zoomValue) {
                dropdown.classList.remove('show');
            }
        });

        const pdfViewerArea = document.getElementById('pdfViewerArea');
        pdfViewerArea.addEventListener('wheel', function(e) {
            if (e.ctrlKey || e.metaKey) {
                e.preventDefault();
                e.stopPropagation();

                const delta = -e.deltaY;

                if (zoomTimeout) {
                    clearTimeout(zoomTimeout);
                }

                zoomTimeout = setTimeout(() => {
                    if (delta > 0) {
                        zoomIn();
                    } else if (delta < 0) {
                        zoomOut();
                    }
                }, 50);

                return false;
            }
        }, { passive: false });
    });

    // ==================== THEME TOGGLE (UPDATED - NO NOTIFICATIONS) ====================
    function loadThemePreference() {
        const savedTheme = localStorage.getItem('pdfViewerTheme');
        console.log('Loading theme preference:', savedTheme);

        if (savedTheme === 'light') {
            isDarkMode = false;
            document.body.classList.add('light-mode');
            updateThemeButton();
        } else {
            isDarkMode = true;
            document.body.classList.remove('light-mode');
            updateThemeButton();
        }
    }

    function toggleTheme() {
        isDarkMode = !isDarkMode;

        console.log('Toggling theme to:', isDarkMode ? 'dark' : 'light');

        if (isDarkMode) {
            document.body.classList.remove('light-mode');
            localStorage.setItem('pdfViewerTheme', 'dark');
        } else {
            document.body.classList.add('light-mode');
            localStorage.setItem('pdfViewerTheme', 'light');
        }

        updateThemeButton();
    }

    function updateThemeButton() {
        const btn = document.getElementById('themeToggleBtn');
        if (btn) {
            if (isDarkMode) {
                btn.innerHTML = '<i class="bi bi-sun-fill"></i>';
                btn.title = 'Switch to Light Mode';
            } else {
                btn.innerHTML = '<i class="bi bi-moon-fill"></i>';
                btn.title = 'Switch to Dark Mode';
            }
        }
    }

    // ==================== ZOOM FUNCTIONS ====================
    function toggleZoomDropdown() {
        const dropdown = document.getElementById('zoomDropdown');
        dropdown.classList.toggle('show');
        updateZoomDropdownActive();
    }

    function updateZoomDropdownActive() {
        const currentZoom = Math.round(scale * 100);
        document.querySelectorAll('.zoom-option').forEach(option => {
            const optionZoom = parseInt(option.textContent);
            option.classList.toggle('active', optionZoom === currentZoom);
        });
    }

    function setZoom(targetScale) {
        document.getElementById('zoomDropdown').classList.remove('show');
        performInstantZoom(targetScale);
    }

    function zoomIn() {
        if (scale >= 3) return;
        performInstantZoom(Math.min(3, Math.round((scale + 0.1) * 100) / 100));
    }

    function zoomOut() {
        if (scale <= 0.25) return;
        performInstantZoom(Math.max(0.25, Math.round((scale - 0.1) * 100) / 100));
    }

    function showZoomIndicator() {
        const indicator = document.getElementById('zoomIndicator');
        indicator.textContent = Math.round(scale * 100) + '%';
        indicator.classList.add('show');

        if (zoomIndicatorTimeout) {
            clearTimeout(zoomIndicatorTimeout);
        }

        zoomIndicatorTimeout = setTimeout(() => {
            indicator.classList.remove('show');
        }, 600);
    }

    function performInstantZoom(targetScale) {
        if (isZooming) {
            pendingZoom = targetScale;
            return;
        }

        isZooming = true;

        const viewer = document.getElementById('pdfViewerArea');
        const currentPage = currentVisiblePage || 1;

        buildPageRegistry();
        const pageData = pageRegistry.get(currentPage);

        if (!pageData) {
            scale = targetScale;
            document.getElementById('zoomValue').textContent = Math.round(scale * 100) + '%';
            updateZoomDropdownActive();
            showZoomIndicator();

            pendingZoom = null;
            reRenderAllPages().then(() => {
                isZooming = false;
                if (pendingZoom !== null) {
                    const nextZoom = pendingZoom;
                    pendingZoom = null;
                    performInstantZoom(nextZoom);
                }
            });
            return;
        }

        const scrollTop = viewer.scrollTop;
        const pageTop = pageData.top;
        const viewportCenter = scrollTop + (viewer.clientHeight / 2);
        const relativePosition = (viewportCenter - pageTop) / pageData.height;

        scale = targetScale;

        document.getElementById('zoomValue').textContent = Math.round(scale * 100) + '%';
        updateZoomDropdownActive();
        showZoomIndicator();

        const wrappers = document.querySelectorAll('.pdf-canvas-wrapper');
        for (let i = 0; i < wrappers.length; i++) {
            const wrapper = wrappers[i];
            const pageNum = parseInt(wrapper.getAttribute('data-page-number'));
            const pageDims = pageHeights.get(pageNum);
            if (pageDims) {
                wrapper.style.width = (pageDims.width * scale) + 'px';
                wrapper.style.minHeight = (pageDims.height * scale) + 'px';
            }
        }

        buildPageRegistry();

        const newPageData = pageRegistry.get(currentPage);
        if (newPageData) {
            const newViewportCenter = newPageData.top + (relativePosition * newPageData.height);
            viewer.scrollTop = newViewportCenter - (viewer.clientHeight / 2);
        }

        pendingZoom = null;

        requestAnimationFrame(() => {
            reRenderAllPages().then(() => {
                isZooming = false;
                if (pendingZoom !== null) {
                    const nextZoom = pendingZoom;
                    pendingZoom = null;
                    performInstantZoom(nextZoom);
                }
            });
        });
    }

    // ==================== PAGE JUMP ====================
    function jumpToPageInstant() {
        const input = document.getElementById('pageJumpInput');
        let pageNumber = parseInt(input.value);

        if (!pageNumber || isNaN(pageNumber)) {
            showNotification("Please enter a valid page number", "warning");
            return;
        }

        const totalPages = pdfDoc ? pdfDoc.numPages : 1;
        pageNumber = Math.max(1, Math.min(pageNumber, totalPages));
        input.value = pageNumber;

        isManualJump = true;

        buildPageRegistry();

        const pageData = pageRegistry.get(pageNumber);
        if (pageData) {
            const viewer = document.getElementById('pdfViewerArea');

            viewer.scrollTop = pageData.top;

            currentVisiblePage = pageNumber;

            updateActiveThumbnailInstant(pageNumber);

            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    isManualJump = false;
                });
            });

        } else {
            console.error('Page data not found:', pageNumber);
            isManualJump = false;
        }
    }

    // ==================== DOCUMENT LOADING ====================
    async function loadDocument(id) {
        try {
            showLoading(true);

            const response = await fetch(`${API_BASE_URL}/DocViewer-view/${id}`);
            if (!response.ok) throw new Error('Failed to load PDF');

            const pdfArrayBuffer = await response.arrayBuffer();
            const loadingTask = pdfjsLib.getDocument({ data: pdfArrayBuffer });
            pdfDoc = await loadingTask.promise;

            const totalPages = pdfDoc.numPages;
            document.getElementById('totalPagesDisplay').textContent = totalPages;
            document.getElementById('pageJumpInput').setAttribute('max', totalPages);
            document.getElementById('pageJumpInput').value = 1;

            await getPageDimensions();
            createPagePlaceholders();
            await loadInitialPages();

            const viewer = document.getElementById('pdfViewerArea');
            viewer.scrollTop = 0;

            setTimeout(() => {
                buildPageRegistry();
                setupPageTracking();
                renderThumbnails();

                currentVisiblePage = 1;
                updateActiveThumbnail(1);

                console.log('✓ Document loaded - Starting at page 1');
                isInitialLoad = false;
            }, 100);

        } catch (error) {
            console.error('Error loading document:', error);
            showError('Failed to load document');
        } finally {
            showLoading(false);
        }
    }

    async function getPageDimensions() {
        for (let i = 1; i <= pdfDoc.numPages; i++) {
            const page = await pdfDoc.getPage(i);
            const viewport = page.getViewport({ scale: 1.0 });
            pageHeights.set(i, {
                width: viewport.width,
                height: viewport.height
            });
        }
    }

    function createPagePlaceholders() {
        const container = document.getElementById('pdfPagesContainer');
        container.innerHTML = '';

        for (let pageNum = 1; pageNum <= pdfDoc.numPages; pageNum++) {
            const pageDims = pageHeights.get(pageNum);
            const scaledWidth = pageDims.width * scale;
            const scaledHeight = pageDims.height * scale;

            const pageWrapper = document.createElement('div');
            pageWrapper.className = 'pdf-canvas-wrapper loading';
            pageWrapper.id = `page-wrapper-${pageNum}`;
            pageWrapper.setAttribute('data-page-number', pageNum);
            pageWrapper.style.width = `${scaledWidth}px`;
            pageWrapper.style.minHeight = `${scaledHeight}px`;

            const pageLabel = document.createElement('div');
            pageLabel.className = 'page-number-label';
            pageLabel.textContent = `Page ${pageNum}`;

            pageWrapper.appendChild(pageLabel);
            container.appendChild(pageWrapper);
        }
    }

    async function loadInitialPages() {
        const pagesToLoad = Math.min(5, pdfDoc.numPages);
        for (let pageNum = 1; pageNum <= pagesToLoad; pageNum++) {
            await renderPage(pageNum);
        }
        setupLazyLoading();
    }

    // ==================== PAGE RENDERING ====================
    async function renderPage(pageNum) {
        try {
            const page = await pdfDoc.getPage(pageNum);
            const viewport = page.getViewport({ scale: scale });
            const pageWrapper = document.getElementById(`page-wrapper-${pageNum}`);
            if (!pageWrapper) return;

            pageWrapper.classList.remove('loading');

            const allExistingCanvases = pageWrapper.querySelectorAll('canvas');
            for (let i = 0; i < allExistingCanvases.length; i++) {
                allExistingCanvases[i].remove();
            }

            const canvas = document.createElement('canvas');
            canvas.id = `pdf-canvas-${pageNum}`;
            canvas.width = viewport.width;
            canvas.height = viewport.height;

            pageWrapper.style.width = viewport.width + 'px';
            pageWrapper.style.minHeight = viewport.height + 'px';

            const pageLabel = pageWrapper.querySelector('.page-number-label');
            pageWrapper.insertBefore(canvas, pageLabel);

            const ctx = canvas.getContext('2d');

            await page.render({
                canvasContext: ctx,
                viewport: viewport
            }).promise;

            addWatermark(ctx, canvas);
            renderedPages.set(pageNum, { canvas, ctx, page });

        } catch (error) {
            console.error(`Error rendering page ${pageNum}:`, error);
        }
    }

    function addWatermark(ctx, canvas) {
        if (!ctx || !canvas) return;

        const watermarkText = window.username || 'User';
        const fontSize = 48;
        const opacity = 0.1;
        const gapX = 300;
        const gapY = 200;

        ctx.save();
        ctx.globalAlpha = opacity;
        ctx.font = fontSize + 'px Arial';
        ctx.fillStyle = '#FF0000';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        ctx.translate(canvas.width / 2, canvas.height / 2);
        ctx.rotate(-Math.PI / 4);
        ctx.translate(-canvas.width / 2, -canvas.height / 2);

        for (let y = -canvas.height; y < canvas.height * 2; y += gapY) {
            for (let x = -canvas.width; x < canvas.width * 2; x += gapX) {
                ctx.fillText(watermarkText, x, y);
            }
        }

        ctx.restore();
    }

    async function reRenderAllPages() {
        const pagesToRerender = Array.from(renderedPages.keys());

        renderedPages.clear();

        const canvases = document.querySelectorAll('.pdf-canvas-wrapper canvas');
        for (let i = 0; i < canvases.length; i++) {
            canvases[i].remove();
        }

        const batchSize = 15;
        for (let i = 0; i < pagesToRerender.length; i += batchSize) {
            const batch = pagesToRerender.slice(i, i + batchSize);
            await Promise.all(batch.map(pageNum => renderPage(pageNum)));
        }

        return Promise.resolve();
    }

    // ==================== LAZY LOADING ====================
    function setupLazyLoading() {
        const options = {
            root: document.getElementById('pdfViewerArea'),
            rootMargin: '500px 0px',
            threshold: 0
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const pageNum = parseInt(entry.target.getAttribute('data-page-number'));
                    if (!renderedPages.has(pageNum)) {
                        renderPage(pageNum);
                    }
                }
            });
        }, options);

        document.querySelectorAll('.pdf-canvas-wrapper').forEach(wrapper => {
            observer.observe(wrapper);
        });
    }

    // ==================== PAGE TRACKING ====================
    let scrollTrackingTimeout = null;
    let isManualJump = false;

    function setupPageTracking() {
        const viewerArea = document.getElementById('pdfViewerArea');

        let ticking = false;
        viewerArea.addEventListener('scroll', function() {
            if (isManualJump) return;

            if (!ticking) {
                window.requestAnimationFrame(function() {
                    if (scrollTrackingTimeout) clearTimeout(scrollTrackingTimeout);

                    scrollTrackingTimeout = setTimeout(() => {
                        detectCurrentPage();
                    }, 100);

                    ticking = false;
                });
                ticking = true;
            }
        }, { passive: true });
    }

    function buildPageRegistry() {
        pageRegistry.clear();
        const wrappers = document.querySelectorAll('.pdf-canvas-wrapper');

        wrappers.forEach((wrapper) => {
            const pageNum = parseInt(wrapper.getAttribute('data-page-number'));
            const height = wrapper.offsetHeight;
            const top = wrapper.offsetTop;

            pageRegistry.set(pageNum, {
                top: top,
                bottom: top + height,
                height: height,
                element: wrapper
            });
        });

        if (pageRegistry.size > 0) {
            const firstThree = Array.from(pageRegistry.entries()).slice(0, 3);
            console.log('✓ Page registry built:',
                firstThree.map(([page, data]) => ({
                    page,
                    top: Math.round(data.top),
                    height: Math.round(data.height)
                }))
            );
        }
    }

    function detectCurrentPage() {
        if (isManualJump) return;

        const viewer = document.getElementById('pdfViewerArea');
        const scrollTop = viewer.scrollTop;
        const viewportHeight = viewer.clientHeight;
        const viewportCenter = scrollTop + (viewportHeight / 2);

        let detectedPage = 1;
        let minDistance = Infinity;

        for (const [pageNum, pageData] of pageRegistry) {
            const pageCenter = pageData.top + (pageData.height / 2);
            const distance = Math.abs(pageCenter - viewportCenter);

            if (distance < minDistance) {
                minDistance = distance;
                detectedPage = pageNum;
            }
        }

        if (detectedPage !== currentVisiblePage) {
            currentVisiblePage = detectedPage;
            document.getElementById('pageJumpInput').value = detectedPage;

            updateActiveThumbnail(detectedPage);
        }
    }

    // ==================== THUMBNAIL FUNCTIONS ====================
    function toggleThumbnailSidebar() {
        document.getElementById('thumbnailSidebar').classList.toggle('closed');
    }

    async function renderThumbnails() {
        if (!pdfDoc) return;

        const container = document.getElementById('thumbnailsContainer');
        container.innerHTML = '';
        const thumbnailScale = 0.2;

        for (let pageNum = 1; pageNum <= pdfDoc.numPages; pageNum++) {
            const thumbnailItem = document.createElement('div');
            thumbnailItem.className = 'thumbnail-item';
            thumbnailItem.id = `thumbnail-${pageNum}`;
            thumbnailItem.setAttribute('data-page', pageNum);

            thumbnailItem.onclick = function() {
                const targetPage = parseInt(this.getAttribute('data-page'));

                isManualJump = true;

                buildPageRegistry();

                const pageData = pageRegistry.get(targetPage);
                if (pageData) {
                    const viewer = document.getElementById('pdfViewerArea');

                    viewer.scrollTop = pageData.top;

                    currentVisiblePage = targetPage;
                    document.getElementById('pageJumpInput').value = targetPage;

                    updateActiveThumbnailInstant(targetPage);

                    requestAnimationFrame(() => {
                        requestAnimationFrame(() => {
                            isManualJump = false;
                        });
                    });
                }
            };

            if (pageNum === 1) thumbnailItem.classList.add('active');

            const canvas = document.createElement('canvas');
            canvas.className = 'thumbnail-canvas';

            const pageNumLabel = document.createElement('div');
            pageNumLabel.className = 'thumbnail-page-num';
            pageNumLabel.textContent = `Page ${pageNum}`;

            thumbnailItem.appendChild(canvas);
            thumbnailItem.appendChild(pageNumLabel);
            container.appendChild(thumbnailItem);

            try {
                const page = await pdfDoc.getPage(pageNum);
                const viewport = page.getViewport({ scale: thumbnailScale });
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                const ctx = canvas.getContext('2d');
                await page.render({ canvasContext: ctx, viewport: viewport }).promise;
            } catch (error) {
                console.error(`Error rendering thumbnail ${pageNum}:`, error);
            }
        }
    }

    function updateActiveThumbnailInstant(pageNum) {
        const allThumbnails = document.querySelectorAll('.thumbnail-item');
        for (let i = 0; i < allThumbnails.length; i++) {
            allThumbnails[i].classList.remove('active');
        }

        const activeThumbnail = document.getElementById(`thumbnail-${pageNum}`);
        if (activeThumbnail) {
            activeThumbnail.classList.add('active');

            activeThumbnail.scrollIntoView({
                behavior: 'instant',
                block: 'center'
            });
        }
    }

    function updateActiveThumbnail(pageNum) {
        console.log(`📍 Updating active thumbnail to page ${pageNum}`);

        document.querySelectorAll('.thumbnail-item').forEach(item => {
            item.classList.remove('active');
        });

        const activeThumbnail = document.getElementById(`thumbnail-${pageNum}`);
        if (activeThumbnail) {
            activeThumbnail.classList.add('active');

            activeThumbnail.scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });

            console.log(`✓ Thumbnail ${pageNum} activated and scrolled into view`);
        } else {
            console.warn(`❌ Thumbnail element not found for page ${pageNum}`);
        }
    }

    // ==================== SIDEBAR TOGGLE ====================
    function toggleSidebar() {
        const sidebar = document.getElementById("sidebar");
        const btn = document.getElementById("toggleSidebarBtn");

        sidebar.classList.toggle("closed");

        if (sidebar.classList.contains("closed")) {
            btn.innerHTML = '<i class="bi bi-arrow-bar-left"></i>';
        } else {
            btn.innerHTML = '<i class="bi bi-arrow-bar-right"></i>';
        }
    }

    // ==================== PRESENT MODE ====================
    function enterPresentMode() {
        isPresentMode = true;
        presentCurrentPage = currentVisiblePage || 1;

        const viewerArea = document.getElementById('pdfViewerArea');
        const controls = document.getElementById('presentModeControls');

        const elem = document.documentElement;
        if (elem.requestFullscreen) {
            elem.requestFullscreen();
        } else if (elem.webkitRequestFullscreen) {
            elem.webkitRequestFullscreen();
        }

        viewerArea.classList.add('present-mode');
        controls.classList.add('show');

        document.querySelector('.unified-nav').style.display = 'none';
        document.getElementById('sidebar').style.display = 'none';
        document.getElementById('thumbnailSidebar').style.display = 'none';
        document.getElementById('toggleSidebarBtn').style.display = 'none';

        updatePresentPageInfo();

        buildPageRegistry();
        const pageData = pageRegistry.get(presentCurrentPage);
        if (pageData) viewerArea.scrollTop = pageData.top;

        document.addEventListener('keydown', handlePresentModeKeys);
    }

    function exitPresentMode() {
        isPresentMode = false;

        const viewerArea = document.getElementById('pdfViewerArea');
        const controls = document.getElementById('presentModeControls');

        if (document.exitFullscreen) {
            document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
        }

        viewerArea.classList.remove('present-mode');
        controls.classList.remove('show');

        document.querySelector('.unified-nav').style.display = 'flex';
        document.getElementById('sidebar').style.display = 'flex';
        document.getElementById('thumbnailSidebar').style.display = 'flex';
        document.getElementById('toggleSidebarBtn').style.display = 'flex';

        document.removeEventListener('keydown', handlePresentModeKeys);
    }

    document.addEventListener('fullscreenchange', handleFullscreenChange);
    document.addEventListener('webkitfullscreenchange', handleFullscreenChange);

    function handleFullscreenChange() {
        const isFullscreen = document.fullscreenElement || document.webkitFullscreenElement;
        if (!isFullscreen && isPresentMode) {
            exitPresentMode();
        }
    }

    function presentPrevPage() {
        if (presentCurrentPage > 1) {
            presentCurrentPage--;
            buildPageRegistry();
            const pageData = pageRegistry.get(presentCurrentPage);
            if (pageData) document.getElementById('pdfViewerArea').scrollTop = pageData.top;
            updatePresentPageInfo();
        }
    }

    function presentNextPage() {
        if (pdfDoc && presentCurrentPage < pdfDoc.numPages) {
            presentCurrentPage++;
            buildPageRegistry();
            const pageData = pageRegistry.get(presentCurrentPage);
            if (pageData) document.getElementById('pdfViewerArea').scrollTop = pageData.top;
            updatePresentPageInfo();
        }
    }

    function updatePresentPageInfo() {
        const totalPages = pdfDoc ? pdfDoc.numPages : 1;
        document.getElementById('presentPageInfo').textContent = `${presentCurrentPage} / ${totalPages}`;
    }

    function handlePresentModeKeys(e) {
        if (!isPresentMode) return;

        switch(e.key) {
            case 'Escape':
                exitPresentMode();
                break;
            case 'ArrowLeft':
            case 'ArrowUp':
                presentPrevPage();
                break;
            case 'ArrowRight':
            case 'ArrowDown':
            case ' ':
                e.preventDefault();
                presentNextPage();
                break;
        }
    }

    // ==================== DOCUMENT INFO (UPDATED WITH EMPTY STATE STYLING) ====================
    function updateDocumentInfo(info) {
        const title = info.title || 'Document';
        const productCode = info.productCode || '';
        const edition = info.edition || '';
        const totalPages = info.totalPages || info.noOfPages || 0;

        document.getElementById('topDocTitle').textContent = title;
        document.getElementById('topDocMeta').textContent = `${productCode} • v${edition} • ${totalPages} pages`;
        document.getElementById('sidebarTitle').textContent = title;
        document.getElementById('sidebarProductCode').textContent = productCode || 'N/A';
        document.getElementById('sidebarEdition').textContent = edition || 'N/A';
        document.getElementById('sidebarPublishDate').textContent = info.publishDate || 'N/A';

        // Notes with empty state styling
        const notesContainer = document.getElementById('sidebarNotes');
        if (info.notes && info.notes.trim() !== '' && info.notes !== 'No notes available') {
            notesContainer.textContent = info.notes;
            notesContainer.classList.remove('empty-state-text');
        } else {
            notesContainer.innerHTML = '<span class="empty-state-text">No notes available</span>';
        }

        // Tags with empty state styling
        const tagsContainer = document.getElementById('sidebarTags');
        if (info.tagNames && info.tagNames.trim() !== '') {
            const tagsArray = info.tagNames.split(',').map(tag => tag.trim());
            tagsContainer.innerHTML = tagsArray.map(tag => `<span class="tag-badge">${tag}</span>`).join('');
        } else {
            tagsContainer.innerHTML = '<span class="empty-state-text">No tags</span>';
        }

        // Classifications with empty state styling
        const clsContainer = document.getElementById('sidebarClassifications');
        if (info.classificationNames && info.classificationNames.trim() !== '') {
            const clsArray = info.classificationNames.split(',').map(c => c.trim());
            clsContainer.innerHTML = clsArray.map(c => `<span class="classification-badge">${c}</span>`).join('');
        } else {
            clsContainer.innerHTML = '<span class="empty-state-text">No classifications</span>';
        }

        // Groups with empty state styling
        const groupsContainer = document.getElementById('sidebarGroups');
        if (info.groupNames && info.groupNames.trim() !== '') {
            const groupsArray = info.groupNames.split(',').map(g => g.trim());
            groupsContainer.innerHTML = groupsArray.map(g => `<span class="group-badge">${g}</span>`).join('');
        } else {
            groupsContainer.innerHTML = '<span class="empty-state-text">No groups assigned</span>';
        }
    }

    // ==================== DATE FORMATTING ====================
    function formatDateToDDMMMYYYY(dateStr) {
        if (!dateStr || dateStr === '-' || dateStr === 'N/A') return dateStr;

        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

        try {
            let date;
            if (/^\d{4}-\d{2}-\d{2}/.test(dateStr)) {
                date = new Date(dateStr.split(' ')[0]);
            } else {
                date = new Date(dateStr);
            }

            if (isNaN(date.getTime())) return dateStr;

            const day = String(date.getDate()).padStart(2, '0');
            const month = monthNames[date.getMonth()];
            const year = date.getFullYear();

            return `${day}-${month}-${year}`;
        } catch (error) {
            return dateStr;
        }
    }

    function formatAllDates() {
        document.querySelectorAll('.format-date').forEach(element => {
            const originalDate = element.textContent.trim();
            if (originalDate && originalDate !== '-' && originalDate !== 'N/A') {
                element.textContent = formatDateToDDMMMYYYY(originalDate);
            }
        });
    }

    // ==================== BOOKMARK FUNCTIONS ====================
    async function checkIfBookmarked() {
        if (!documentId) return;

        try {
            const response = await fetch(`/bookmark/check/${documentId}`);
            if (response.ok) {
                const data = await response.json();
                isCurrentlyBookmarked = typeof data === 'object' ? data.bookmarked : data;
                updateBookmarkButton(isCurrentlyBookmarked);
            }
        } catch (error) {
            console.error("Error checking bookmark status:", error);
        }
    }

    function updateBookmarkButton(isBookmarked) {
        const bookmarkBtn = document.getElementById("bookmarkIconBtn");
        const bookmarkIcon = document.getElementById("bookmarkIcon");

        if (!bookmarkBtn || !bookmarkIcon) return;

        bookmarkBtn.disabled = false;
        bookmarkBtn.style.cursor = 'pointer';

        if (isBookmarked) {
            bookmarkBtn.classList.add('active');
            bookmarkIcon.className = "bi bi-bookmark-fill";
        } else {
            bookmarkBtn.classList.remove('active');
            bookmarkIcon.className = "bi bi-bookmark";
        }
    }

    function handleBookmarkClick() {
        if (isCurrentlyBookmarked) {
            showRemoveBookmarkModal();
        } else {
            showBookmarkModal();
        }
    }

    function showBookmarkModal() {
        document.getElementById("bookmarkModal").classList.add("active");
        document.getElementById("bookmarkName").value = "";
    }

    function closeBookmarkModal() {
        document.getElementById("bookmarkModal").classList.remove("active");
    }

    function showRemoveBookmarkModal() {
        document.getElementById("removeBookmarkModal").classList.add("active");
    }

    function closeRemoveBookmarkModal() {
        document.getElementById("removeBookmarkModal").classList.remove("active");
    }

    async function saveBookmark() {
        const name = document.getElementById("bookmarkName").value.trim();
        if (!name) {
            showNotification("Please enter a bookmark name", "warning");
            return;
        }

        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute("content");
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute("content");

        try {
            const response = await fetch(`/documents/bookmark/${documentId}?page=1&name=${encodeURIComponent(name)}`, {
                method: "POST",
                headers: { [csrfHeader]: csrfToken }
            });

            const errorText = await response.text();

            if (response.ok) {
                closeBookmarkModal();
                showNotification("Bookmark saved successfully!", "success");
                isCurrentlyBookmarked = true;
                updateBookmarkButton(true);
            } else if (response.status === 409 || errorText.toLowerCase().includes("already")) {
                closeBookmarkModal();
                showNotification("This document is already bookmarked", "warning");
                isCurrentlyBookmarked = true;
                updateBookmarkButton(true);
            } else {
                showNotification("Failed to save bookmark", "error");
            }
        } catch (error) {
            showNotification("Failed to save bookmark", "error");
        }
    }

    async function confirmRemoveBookmark() {
        if (!documentId) return;

        const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute("content");
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute("content");

        try {
            const response = await fetch(`/bookmarks/document/${documentId}`, {
                method: "DELETE",
                headers: {
                    [csrfHeader]: csrfToken,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                closeRemoveBookmarkModal();
                showNotification("Bookmark removed successfully!", "success");
                isCurrentlyBookmarked = false;
                updateBookmarkButton(false);
            } else if (response.status === 404) {
                showNotification("Bookmark not found", "warning");
                isCurrentlyBookmarked = false;
                updateBookmarkButton(false);
                closeRemoveBookmarkModal();
            } else {
                showNotification("Failed to remove bookmark", "error");
            }
        } catch (error) {
            showNotification("Network error", "error");
        }
    }

    // ==================== DOWNLOAD FUNCTIONS ====================
    function showDownloadModal() {
        document.getElementById('downloadModal').classList.add('active');
    }

    function closeDownloadModal() {
        document.getElementById('downloadModal').classList.remove('active');
    }

    async function confirmDownload() {
        try {
            const response = await fetch(`/documents/download/${documentId}`);
            if (!response.ok) throw new Error('Download failed');

            const blob = await response.blob();
            const contentDisposition = response.headers.get('content-disposition');
            let filename = 'watermarked_document.pdf';
            if (contentDisposition) {
                const match = contentDisposition.match(/filename="(.+)"/);
                if (match) filename = match[1];
            }

            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            closeDownloadModal();
            showNotification('PDF downloaded successfully', 'success');
        } catch (error) {
            showNotification('Failed to download PDF', 'error');
        }
    }

    // ==================== UTILITY FUNCTIONS ====================
    function showLoading(show) {
        document.getElementById('loadingSpinner').classList.toggle('active', show);
    }

    function showNotification(message, type = 'success') {
        const notification = document.getElementById('notification');
        const text = document.getElementById('notificationText');

        notification.className = `notification ${type} show`;
        text.textContent = message;

        setTimeout(() => {
            notification.classList.remove('show');
        }, 5000);
    }

    function closeNotification() {
        document.getElementById('notification').classList.remove('show');
    }

    function showError(message) {
        showNotification(message, 'error');
    }

    // ==================== KEYBOARD SHORTCUTS ====================
    document.addEventListener('keydown', function(e) {
        if (e.target.tagName === 'INPUT') return;

        if ((e.ctrlKey || e.metaKey) && e.key === '+') {
            e.preventDefault();
            zoomIn();
        } else if ((e.ctrlKey || e.metaKey) && e.key === '-') {
            e.preventDefault();
            zoomOut();
        } else if ((e.ctrlKey || e.metaKey) && e.key === '0') {
            e.preventDefault();
            setZoom(1.0);
        }
    });

    window.addEventListener('click', function(e) {
        if (e.target.classList.contains('modal')) {
            e.target.classList.remove('active');
        }
    });
</script>

<!-- ==================== SECURITY SCRIPT ====================-->
<script>
    (function() {
        const BLUR_INTENSITY = '20px';
        let isBlurred = false;

        const securityMessages = {
            screenshot: 'Screenshots and screen captures are not allowed for this document.',
            print: 'Printing is disabled for security purposes.',
            copy: 'Copying content from this document is not permitted.',
            devtools: 'Developer tools access is restricted.',
            save: 'Saving this document directly is not allowed.',
            snipping: 'Snipping tool and screen capture are blocked for this document.',
            default: 'This action is not permitted for security reasons.'
        };

        function showSecurityNotification(messageType) {
            const message = securityMessages[messageType] || securityMessages.default;
            if (typeof showNotification === 'function') {
                showNotification(message, 'error');
            }
        }

        function applySecurityBlur() {
            if (!isBlurred) {
                isBlurred = true;
                document.body.style.filter = `blur(${BLUR_INTENSITY})`;
                const pdfContainer = document.getElementById('pdfPagesContainer');
                if (pdfContainer) pdfContainer.style.visibility = 'hidden';
            }
        }

        function removeSecurityBlur() {
            if (isBlurred) {
                isBlurred = false;
                document.body.style.filter = 'none';
                const pdfContainer = document.getElementById('pdfPagesContainer');
                if (pdfContainer) pdfContainer.style.visibility = 'visible';
            }
        }

        document.addEventListener('contextmenu', e => {
            e.preventDefault();
            showSecurityNotification('copy');
        });

        document.addEventListener('dragstart', e => e.preventDefault());

        document.addEventListener('selectstart', e => {
            if (e.target.closest('.pdf-viewer-area')) {
                e.preventDefault();
            }
        });

        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key.toLowerCase() === 'p') {
                e.preventDefault();
                showSecurityNotification('print');
                return false;
            }

            if (e.ctrlKey && e.key.toLowerCase() === 's') {
                e.preventDefault();
                showSecurityNotification('save');
                return false;
            }

            if (e.ctrlKey && e.key.toLowerCase() === 'u') {
                e.preventDefault();
                showSecurityNotification('devtools');
                return false;
            }

            if (e.ctrlKey && e.shiftKey && ['i', 'j', 'c', 'k'].includes(e.key.toLowerCase())) {
                e.preventDefault();
                showSecurityNotification('devtools');
                return false;
            }

            if (e.key === 'F12') {
                e.preventDefault();
                showSecurityNotification('devtools');
                return false;
            }

            if (e.key === 'PrintScreen') {
                e.preventDefault();
                applySecurityBlur();
                showSecurityNotification('screenshot');
                navigator.clipboard.writeText('').catch(() => {});
                setTimeout(removeSecurityBlur, 3000);
                return false;
            }

            if (e.shiftKey && e.key.toLowerCase() === 's' && (e.metaKey || e.getModifierState('OS'))) {
                e.preventDefault();
                applySecurityBlur();
                showSecurityNotification('snipping');
                setTimeout(removeSecurityBlur, 3000);
                return false;
            }

            if (e.altKey && e.key === 'PrintScreen') {
                e.preventDefault();
                applySecurityBlur();
                showSecurityNotification('screenshot');
                navigator.clipboard.writeText('').catch(() => {});
                setTimeout(removeSecurityBlur, 3000);
                return false;
            }
        }, true);

        window.addEventListener('keyup', function(e) {
            if (e.key === 'PrintScreen') {
                applySecurityBlur();
                navigator.clipboard.writeText('').catch(() => {});
                showSecurityNotification('screenshot');
                setTimeout(removeSecurityBlur, 3000);
            }
        }, true);

        document.addEventListener('copy', e => {
            e.preventDefault();
            showSecurityNotification('copy');
        });

        document.addEventListener('cut', e => {
            e.preventDefault();
            showSecurityNotification('copy');
        });

        let blurTimeout;
        window.addEventListener('blur', () => {
            applySecurityBlur();
            if (blurTimeout) clearTimeout(blurTimeout);
        });

        window.addEventListener('focus', () => {
            blurTimeout = setTimeout(removeSecurityBlur, 500);
        });

        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                applySecurityBlur();
            } else {
                setTimeout(removeSecurityBlur, 500);
            }
        });

        window.onbeforeprint = function() {
            applySecurityBlur();
            showSecurityNotification('print');
        };

        window.onafterprint = removeSecurityBlur;

        window.print = function() {
            showSecurityNotification('print');
            return false;
        };
    })();
</script>
</body>
</html>